import os
import re
import asyncio
from flask import Flask, request
from telegram import Update, ReplyKeyboardRemove
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ConversationHandler,
    ContextTypes,
    filters,
)
from dotenv import load_dotenv
from authorize_gmail import send_welcome_email  # âœ… Ensure this file exists

# ========== Load environment variables ==========
load_dotenv()
TOKEN = os.getenv("TELEGRAM_TOKEN")
PORT = int(os.environ.get("PORT", 10000))

# ========== Telegram conversation states ==========
ASK_NAME, ASK_EMAIL = range(2)

# ========== Helper: validate email ==========
def is_valid_email(email_str: str) -> bool:
    pattern = r"^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$"
    return re.match(pattern, email_str) is not None

# ========== Flask app (for Render hosting) ==========
flask_app = Flask(__name__)

# ========== Telegram Bot Logic ==========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ‘‹ Ø³Ù„Ø§Ù…! Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return ASK_NAME

async def ask_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    name = update.message.text.strip()
    context.user_data["name"] = name
    await update.message.reply_text("Ø®ÛŒÙ„ÛŒ Ù‡Ù… Ø¹Ø§Ù„ÛŒ ğŸŒŸ Ø­Ø§Ù„Ø§ Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return ASK_EMAIL

async def ask_email(update: Update, context: ContextTypes.DEFAULT_TYPE):
    email_input = update.message.text.strip()
    name = context.user_data.get("name")

    if not is_valid_email(email_input):
        await update.message.reply_text("âŒ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return ASK_EMAIL

    await update.message.reply_text(
        f"âœ… Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§ ({email_input}) Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.\n"
        "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ Ù‡Ø³ØªÙ…..."
    )

    try:
        sent = send_welcome_email(name, email_input)
        await asyncio.sleep(1)

        if sent:
            await update.message.reply_text(
                "ğŸ“¬ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!\n"
                "Ø§Ú¯Ø± Ø¯Ø± Inbox Ù†Ø¨ÙˆØ¯ØŒ Ù„Ø·ÙØ§Ù‹ Ù¾ÙˆØ´Ù‡â€ŒÛŒ Spam Ø±Ø§ Ù‡Ù… Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."
            )
        else:
            await update.message.reply_text(
                "âš ï¸ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯."
            )
    except Exception as e:
        print("âŒ Email sending error:", e)
        await update.message.reply_text(
            "âš ï¸ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯."
        )

    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ú¯ÙØªâ€ŒÙˆÚ¯Ùˆ Ù„ØºÙˆ Ø´Ø¯.", reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END

# ========== Build Telegram Application ==========
application = Application.builder().token(TOKEN).build()

conv_handler = ConversationHandler(
    entry_points=[CommandHandler("start", start)],
    states={
        ASK_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_name)],
        ASK_EMAIL: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_email)],
    },
    fallbacks=[CommandHandler("cancel", cancel)],
)

application.add_handler(conv_handler)

# ========== Flask Routes ==========
@flask_app.route(f"/{TOKEN}", methods=["POST"])
async def webhook():
    """Handle incoming Telegram updates via webhook"""
    try:
        update = Update.de_json(request.get_json(force=True), application.bot)
        await application.process_update(update)
    except Exception as e:
        print("âŒ Webhook error:", e)
    return "ok"

@flask_app.route("/")
def index():
    return "âœ… Digital Marketing Bot is alive!"

# ========== Webhook Setup ==========
async def set_webhook():
    webhook_url = f"https://digitalmarketingbiz-bot.onrender.com/{TOKEN}"
    await application.bot.set_webhook(webhook_url)
    print(f"âœ… Webhook set to: {webhook_url}")

# ========== Entry Point ==========
if __name__ == "__main__":
    print("ğŸš€ Starting Digital Marketing Bot (Webhook Mode)...")
    asyncio.run(set_webhook())
    flask_app.run(host="0.0.0.0", port=PORT)
